<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;600&display=swap" rel="stylesheet">  
  <title>Active Position Tracker</title>
  <style>
    body {
      background-color: #121212;
      color: #f0f0f0;
      font-family: 'Exo 2', sans-serif;
      padding: 1rem;
      margin: 0;
    }

    .container {
      max-width: 600px;
      max-height: 70px;
      margin: auto;
      background-color: #1e1e1e;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.6);
    }

    h2 {
      text-align: center;
      margin-bottom: 1rem;
      color: #00d1b2;
    }

    .bar-wrapper {
      background: #333;
      border-radius: 10px;
      position: relative;
      height: 12px;
      margin: 20px 0;
      overflow: hidden;
    }

    .bar {
      position: absolute;
      height: 100%;
      background: linear-gradient(90deg, #00c896, #00e6a1);
      box-shadow: 0 0 12px #00e6a1aa;
      transition: left 0.2s;
      border-radius: 10px;
    }

    .labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: #aaa;
      margin-top: 3px;
    }

    .status {
      margin-top: 1.3rem;
      margin-bottom: 1.5rem;
      font-size: 1rem;
      text-align: center;
    }

    .counters {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .counters p {
      flex: 1 1 45%; /* two columns, with some space */
      margin: 0;
    }


    .pulse {
      animation: pulseGlow 1.5s infinite ease-in-out;
    }

    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 0 8px #00e6a1aa;
      }
      50% {
        box-shadow: 0 0 18px #00ffc2dd;
      }
    }
  </style>
</head>
<body>
  <div class="container">

    <div class="bar-wrapper">
      <div id="bar" class="bar pulse" style="width: 50%"></div>
    </div>
    <div class="labels">
      <span id="sl">SL</span>
      <span id="entry">Entry</span>
      <span id="tp">TP</span>
    </div>
    <div class="status" id="statusText">
      Loading position info...
    </div>

  <div class="counters">
    <p>‚úÖ TP Hits: <span id="tp_count">0</span></p>
    <p>üîÅ DCA Events: <span id="dca_count">0</span></p>
    <p>üí∞ Profit Capture: <span id="profit_capture">0</span></p>
    <p>üí∏ Loss Limit: <span id="loss_limit">0</span></p>
  </div>


  </div>

<script>
  async function fetchPosition() {
    const res = await fetch('/api/position');
    const data = await res.json();
    if (!data || !data.entry || !data.tp) {
      document.getElementById("statusText").innerText = "No active position.";
      document.getElementById("bar").style.width = "0%";
      document.getElementById("sl").innerText = "-";
      document.getElementById("entry").innerText = "-";
      document.getElementById("tp").innerText = "-";
      document.getElementById("tp_count").textContent = tp_count;
      document.getElementById("dca_count").textContent = dca_count;
      document.getElementById("profit_capture").textContent = profit_capture;
      document.getElementById("loss_limit").textContent = loss_limit;
      return;
    }

    const { side, entry, tp, timestamp, current_price, live_pnl_percent, tp_count, dca_count, sl } = data;

    // === Corrected bar calculation ===
    let min, max, clamped, percent;
    if (side === "long") {
      min = sl;
      max = tp;
      clamped = Math.min(Math.max(current_price, min), max);
      percent = ((clamped - min) / (max - min)) * 100;
    } else {
      min = tp;
      max = sl;
      clamped = Math.min(Math.max(current_price, min), max);
      percent = 100 - ((clamped - min) / (max - min)) * 100;
    }
    document.getElementById("bar").style.width = percent + "%";

    // === Set label values from API ===
    document.getElementById("sl").innerText = parseFloat(sl).toFixed(4);
    document.getElementById("entry").innerText = parseFloat(entry).toFixed(4);
    document.getElementById("tp").innerText = parseFloat(tp).toFixed(4);

    // === Duration formatting ===
    const openedAt = new Date(timestamp);
    const now = new Date();
    const seconds = Math.floor((now - openedAt) / 1000);
    const duration = seconds < 60
      ? `${seconds}s`
      : seconds < 3600
        ? `${Math.floor(seconds / 60)}m ${seconds % 60}s`
        : `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;

    document.getElementById("statusText").innerText = 
      `Position: ${side.toUpperCase()}, live PnL: ${live_pnl_percent}% ‚Äî Active for: ${duration}`;

    document.getElementById("tp_count").textContent = tp_count;
    document.getElementById("dca_count").textContent = dca_count;
  }

  fetchPosition();
  setInterval(fetchPosition, 5000);
</script>



</body>
</html>
